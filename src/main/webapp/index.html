<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="content-type"></meta>
<title>Brain</title>
</head>

<body class="lift:content_id=main">
    <div id="main" class="lift:surround?with=default;at=content">
    <div class="lift:App.onLoad"></div>

    <div id="theTree">
        <div id="infovis" class="infovis"></div>
    </div>
    <div id="log"></div>


        <!-- Modal -->
        <div id="createKnowledgeWindow" style="width: 100%; height: 100%;">
            <form class="lift:form.ajax">
                <div data-lift="createKnowledgeForm">
                    <table style="width: 100%; height: 100%;">
                        <tr>
                            <td><label for="createKnowledgeNameInput">Name</label></td>
                            <td><input type="text" id="createKnowledgeNameInput" placeholder="Enter new Knowledge name"></td>
                        </tr>
                        <tr><td colspan="2"><span id="createKnowledgeWindowStatus" style="color: red"></span></td></tr>
                        <tr><td colspan="2"><input type="hidden" name="parentId"><hr></td></tr>
                        <tr align="right"><td colspan="2"><button type="submit" >Save changes</button><button onclick="createKowledgeWindow.hide();">Cancel</button></td></tr>
                    </table>
                </div>
            </form>
        </div>
        
        <!-- Modal -->
        <div id="updateKnowledgeWindow" style="width: 100%; height: 100%;">
            <form class="lift:form.ajax">
                <div data-lift="updateKnowledgeForm">
                    <table style="width: 100%; height: 100%;">
                        <tr>
                            <td><label for="updateKnowledgeNameInput">Name</label></td>
                            <td><input type="text" id="updateKnowledgeNameInput" placeholder="Enter new Knowledge name"></td>
                        </tr>
                        <tr><td colspan="2"><span id="updateKnowledgeWindowStatus" style="color: red"></span></td></tr>
                        <tr><td colspan="2"><input type="hidden" name="id"><hr></td></tr>
                        <tr align="right"><td colspan="2"><button type="submit" >Save changes</button><button onclick="updateKowledgeWindow.hide();">Cancel</button></td></tr>
                    </table>
                </div>
            </form>
        </div>
        
                                    
        <!-- Modal -->
        <!-- Modal -->
        <div id="deleteKnowledgeWindow" style="width: 100%; height: 100%;">
            <form class="lift:form.ajax">
                <div data-lift="deleteKnowledgeForm">
                    <table style="width: 100%; height: 100%;">
                        <tr><td>Confirm to delete this knowledge?</td></tr>
                        <tr><td><span id="deleteKnowledgeWindowStatus" style="color: red"></span></td></tr>
                        <tr><td><input type="hidden" name="id"><hr></td></tr>
                        <tr align="right"><td><button type="submit" >Save changes</button><button onclick="deleteKowledgeWindow.hide();">Cancel</button></td></tr>
                    </table>
                </div>
            </form>
        </div>
        
<!--         Modal
        <div id="informationWindow" style="width: 100%; height: 100%;">
            <form class="lift:form.ajax">
                <div data-lift="createKnowledgeForm">
                    <table style="width: 100%; height: 100%;">
                        <tr>
                            <td><label for="createKnowledgeNameInput">Name</label></td>
                            <td><input type="text" id="createKnowledgeNameInput" placeholder="Enter new Knowledge name"></td>
                        </tr>
                        <tr><td colspan="2"><span id="createKnowledgeWindowStatus" style="color: red"></span></td></tr>
                        <tr><td colspan="2"><input type="hidden" name="parentId"><hr></td></tr>
                        <tr align="right"><td colspan="2"><button type="submit" >Save changes</button><button onclick="createKowledgeWindow.hide();">Cancel</button></td></tr>
                    </table>
                </div>
            </form>
        </div> -->
        
        <div id="teachingWindow" style="width: 100%; height: 100%;">
            <form class="lift:form.ajax">
                <div data-lift="createKnowledgeForm">
                    <table style="width: 100%; height: 100%;">
                        <tr>
                            <td><label for="whenUserSayInput">When the user says</label></td>
                            <td><textarea id="whenUserSayInput" rows="5" cols="50" placeholder="likely user's sentences (one per line)"></textarea></td>
                        </tr>
                        <tr>
                            <td><label for="respondingToInput">Responding to</label></td>
                            <td><input type="text" style="width: 410px" id="respondingToInput" placeholder="some bot phrase"></td>
                        </tr>
                        <tr>
                            <td><label for="memorizeInput">Memorize</label></td>
                            <td><textarea id="memorizeInput" rows="5" cols="50" placeholder="some key=value pair like: name='Israel' (one per line)"></textarea></td>
                        </tr>
                        <tr>
                            <td><label for="thinkInput">Say</label></td>
                            <td><textarea id="thinkInput" rows="5" cols="50" placeholder="The bot's responses to the user input. Can access memorized variables. Example: Hello, ${name}. (one per line)"></textarea></td>
                        </tr>
                        <tr><td colspan="2"><span id="createTeachingWindowStatus" style="color: red"></span></td></tr>
                        <tr><td colspan="2"><input type="hidden" name="parentId"><hr></td></tr>
                        <tr align="right"><td colspan="2"><button type="submit" >Save changes</button><button onclick="createKowledgeWindow.hide();">Cancel</button></td></tr>
                    </table>
                </div>
            </form>
        </div>

        
    <script type="text/javascript">
    
        document.onclick       = function(e) { $knowledgeContextMenu.hide(); };
        document.oncontextmenu = function(e) { return false; };
        var $knowledgeContextMenu = $("#knowledgeContextMenu");
        
        preparaModal( "#createKnowledgeModal", "#createKnowledgeNameInput", function(){$("#createKnowledgeModal").find("#into").val(ObjectManager.lastClicked.id)});
        preparaModal( "#updateKnowledgeModal", "#updateKnowledgeNameInput", function(){
                                                          $("#updateKnowledgeNameInput").val(ObjectManager.lastClicked.name);
                                                          $("#whatToRename").val(ObjectManager.lastClicked.id);
                                                         });
        preparaModal( "#deleteKnowledgeModal", "#cancelDelete", function(){
        	$("#whatKnowledgeToDelete").val(ObjectManager.lastClicked.id);
        });
        //preparaModal( "#moveKnowledgeModal", true, function(){});
        //preparaModal( "#copyKnowledgeModal", true, function(){});
        preparaModal( "#topicModal", false, function(){});
  
        function preparaModal(modalId, elementIdToFocus, func){
        	var modal = $(modalId) 
        	modal.
            on('shown.bs.modal', function() { func(); if(elementIdToFocus)$(elementIdToFocus).focus();} ).
            on('hide.bs.modal',  function() { resetModal(modalId);} )
        }
					  
				function resetModal(modalId) {
					input = $(modalId).find('input')
					if(input.length>0)input[0].form.reset();
					$(modalId + "Status").html('');
				}
				
				function afterUpdateKnowledge(knowledge){
					$('#updateKnowledgeModal').modal('hide');

					lastClikedNode = ObjectManager.lastClicked;
					Log.info("Knowledege '"+lastClikedNode.name+"' renamed to '" + knowledge.name + "' successfully.");
					
					lastClikedNode.name = knowledge.name
					document.getElementById(knowledge.id).innerHTML=knowledge.name
				}

				function afterCreateKnowledge(newKnowledge) {
					$('#createKnowledgeModal').modal('hide');

					Log.info("Knowledege named '" + newKnowledge.name + "' added successfully.");
					lastClikedNode = ObjectManager.lastClicked;
					
					st.addSubtree(
							{
								  id : lastClikedNode.id,
								  children : [ newKnowledge ]
							}, 
							'replot', 
							{
								  hideLabels : false,
								  duration : 800,
								  onComplete : function() {
									  if (st.clickedNode.id != lastClikedNode.id) {
										  st.onClick(lastClikedNode.id);
										}
									  Log.info('Done');
									}
							}
					  )
					}

					function afterDeleteKnowledge(knowledge) {
						$('#deleteKnowledgeModal').modal('hide');
						
						var lastClickedNode = ObjectManager.lastClicked;
						var nodeParent = null;

						if (lastClickedNode) {
							if (lastClickedNode.getParents().length == 0) {
								Log.info("Is not possible to delete the tree's root knowledge.");
								return false;
							}
							nodeParent = lastClickedNode.getParents()[0];
							ObjectManager.setLastClicked(nodeParent);
							st.onClick(nodeParent.id);
						}

						st.removeSubtree(
							lastClickedNode.id,
							true,
							'animate',
							{
								duration : 500,
								hideLabels : false,
								onComplete : function() {
									Log.info("Knowledge '"+knowledge.name+"' deleted successfully.");
								}
							})
					}
				</script>

    </div>
    
    <!-- /main -->
</body>
</html>
